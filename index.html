<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crop Template - DSRT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #previewImage {
      max-width: 100%;
      max-height: 400px;
      transition: all 0.3s;
    }
    #cropBox {
      position: absolute;
      border: 2px dashed #22d3ee;
      display: none;
    }
    #cropBox.circle {
      border-radius: 50%;
    }
    /* tombol upload overlay */
    #uploadBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(34,211,238,0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">
  <h1 class="text-xl font-bold text-cyan-400 mb-4">Macam-macam Crop + Upload di Canvas</h1>

  <!-- Image preview dengan tombol upload di atasnya -->
  <div class="relative bg-gray-700 rounded-xl flex items-center justify-center p-2">
    <img id="previewImage" src="https://via.placeholder.com/500" alt="Preview">
    <div id="cropBox"></div>
    <!-- Tombol upload -->
    <label id="uploadBtn">
      Upload
      <input id="fileInput" type="file" accept="image/*" class="hidden">
    </label>
  </div>

  <!-- Crop Options -->
  <div class="mt-4 flex gap-2 flex-wrap">
    <button class="crop-mode px-3 py-1 bg-gray-700 rounded" data-mode="free">Free Crop</button>
    <button class="crop-mode px-3 py-1 bg-gray-700 rounded" data-mode="square">1:1</button>
    <button class="crop-mode px-3 py-1 bg-gray-700 rounded" data-mode="landscape">16:9</button>
    <button class="crop-mode px-3 py-1 bg-gray-700 rounded" data-mode="portrait">4:3</button>
    <button class="crop-mode px-3 py-1 bg-gray-700 rounded" data-mode="circle">Circle</button>
    <button id="applyCrop" class="px-3 py-1 bg-cyan-600 rounded">Apply Crop</button>
  </div>

  <canvas id="canvas" class="hidden"></canvas>

  <script>
    const img = document.getElementById('previewImage');
    const fileInput = document.getElementById('fileInput');
    const cropBox = document.getElementById('cropBox');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let cropActive = false;
    let startX, startY, endX, endY;
    let cropMode = "free";

    // Upload gambar
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => { img.src = ev.target.result; };
      reader.readAsDataURL(file);
    });

    // Mode crop
    document.querySelectorAll('.crop-mode').forEach(btn => {
      btn.addEventListener('click', () => {
        cropMode = btn.dataset.mode;
        cropActive = true;
        cropBox.classList.remove('circle');
        if (cropMode === "circle") cropBox.classList.add('circle');
        cropBox.style.display = "none";
      });
    });

    // Mouse drag
    img.parentElement.addEventListener('mousedown', e => {
      if (!cropActive) return;
      const rect = img.getBoundingClientRect();
      startX = e.clientX;
      startY = e.clientY;
      cropBox.style.left = `${startX - rect.left}px`;
      cropBox.style.top = `${startY - rect.top}px`;
      cropBox.style.width = "0px";
      cropBox.style.height = "0px";
      cropBox.style.display = "block";
      img.parentElement.addEventListener('mousemove', resizeCrop);
    });
    document.addEventListener('mouseup', () => {
      img.parentElement.removeEventListener('mousemove', resizeCrop);
    });

    function resizeCrop(e) {
      const rect = img.getBoundingClientRect();
      endX = e.clientX;
      endY = e.clientY;
      let w = endX - startX;
      let h = endY - startY;

      // aspect ratio
      if (cropMode === "square") {
        h = w;
      } else if (cropMode === "landscape") {
        h = w * 9/16;
      } else if (cropMode === "portrait") {
        h = w * 3/4;
      }

      cropBox.style.width = `${w}px`;
      cropBox.style.height = `${h}px`;
    }

    // Apply crop
    document.getElementById('applyCrop').addEventListener('click', () => {
      if (!startX || !endX) return;
      const rect = img.getBoundingClientRect();

      const scaleX = img.naturalWidth / rect.width;
      const scaleY = img.naturalHeight / rect.height;

      const sx = (startX - rect.left) * scaleX;
      const sy = (startY - rect.top) * scaleY;
      const sw = (endX - startX) * scaleX;
      const sh = (endY - startY) * scaleY;

      canvas.width = sw;
      canvas.height = sh;
      ctx.clearRect(0, 0, sw, sh);

      if (cropMode === "circle") {
        ctx.save();
        ctx.beginPath();
        ctx.arc(sw/2, sh/2, Math.min(sw, sh)/2, 0, Math.PI * 2);
        ctx.closePath();
        ctx.clip();
      }

      ctx.drawImage(img, sx, sy, sw, sh, 0, 0, sw, sh);

      if (cropMode === "circle") ctx.restore();

      img.src = canvas.toDataURL();
      cropBox.style.display = "none";
      cropActive = false;
    });
  </script>
</body>
</html>
